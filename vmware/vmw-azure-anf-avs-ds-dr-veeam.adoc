---
sidebar: sidebar 
permalink: vmware/vmw-azure-anf-avs-ds-dr-veeam.html 
keywords: disaster recovery, avs, azure vmware solution, anf, azure netapp files, disaster recovery, dr, veeam, replication 
summary:  
---
= Utilizzo di Veeam Replication e del datastore Azure NetApp Files per il disaster recovery nella soluzione Azure VMware
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Gli archivi dati di Azure NetApp Files (ANF) separano l'archiviazione dall'elaborazione e offrono la flessibilità necessaria a qualsiasi organizzazione per trasferire i propri carichi di lavoro sul cloud.  Fornisce ai clienti un'infrastruttura di storage flessibile e ad alte prestazioni, scalabile indipendentemente dalle risorse di elaborazione.  L'archivio dati Azure NetApp Files semplifica e ottimizza la distribuzione insieme ad Azure VMware Solution (AVS) come sito di disaster recovery per ambienti VMWare locali.



== Panoramica

Gli archivi dati NFS basati su volumi Azure NetApp Files (ANF) possono essere utilizzati per replicare i dati da ambienti locali tramite qualsiasi soluzione di terze parti convalidata che fornisca funzionalità di replica delle VM.  Aggiungendo gli archivi dati di Azure NetApp Files , sarà possibile ottimizzare i costi di distribuzione rispetto alla creazione di un SDDC di Azure VMware Solution con un'enorme quantità di host ESXi per ospitare l'archiviazione.  Questo approccio è chiamato "Pilot Light Cluster".  Un cluster di luci pilota è una configurazione host AVS minima (3 nodi AVS) insieme alla capacità di Azure NetApp Files Datastore.

L'obiettivo è mantenere un'infrastruttura a basso costo con tutti i componenti principali per gestire un failover.  Un cluster di luci pilota può essere ampliato e predisporre più host AVS in caso di failover.  Una volta completato il failover e ripristinate le normali operazioni, il gruppo di spie luminose può tornare a funzionare in modalità a basso costo.



== Scopi del presente documento

In questo articolo viene descritto come utilizzare il datastore di Azure NetApp Files con Veeam Backup and Replication per configurare il disaster recovery per le VM VMware locali (AVS) utilizzando la funzionalità del software di replica delle VM Veeam.

Veeam Backup & Replication è un'applicazione di backup e replica per ambienti virtuali.  Quando le macchine virtuali vengono replicate, Veeam Backup & Replication viene replicato da AVS; il software creerà una copia esatta delle VM nel formato nativo VMware vSphere sul cluster AVS SDDC di destinazione.  Veeam Backup & Replication manterrà la copia sincronizzata con la VM originale.  La replica fornisce il miglior obiettivo di tempo di ripristino (RTO) poiché è presente una copia montata di una VM nel sito DR in uno stato pronto per l'avvio.

Questo meccanismo di replicazione garantisce che i carichi di lavoro possano essere avviati rapidamente in un AVS SDDC in caso di evento disastroso.  Il software Veeam Backup & Replication ottimizza anche la trasmissione del traffico per la replica su WAN e connessioni lente.  Inoltre, filtra anche i blocchi di dati duplicati, i blocchi di dati zero, i file di swap e i "file del sistema operativo guest della VM esclusi".  Il software comprimerà anche il traffico di replica.  Per evitare che i processi di replicazione consumino l'intera larghezza di banda della rete, è possibile utilizzare acceleratori WAN e regole di limitazione della rete.

Il processo di replica in Veeam Backup & Replication è guidato dai processi, ovvero la replica viene eseguita configurando i processi di replica.  In caso di disastro, è possibile attivare il failover per ripristinare le VM eseguendo il failover sulla relativa copia replica.  Quando viene eseguito il failover, una VM replicata assume il ruolo della VM originale.  Il failover può essere eseguito sullo stato più recente di una replica o su uno qualsiasi dei suoi punti di ripristino noti.  Ciò consente il ripristino da ransomware o test isolati, a seconda delle necessità.  Veeam Backup & Replication offre diverse opzioni per gestire diversi scenari di disaster recovery.

image:dr-veeam-anf-001.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]



== Distribuzione della soluzione



=== Gradini di alto livello

. Il software Veeam Backup and Replication è in esecuzione in un ambiente locale con connettività di rete adeguata.
. link:https://learn.microsoft.com/en-us/azure/azure-vmware/deploy-azure-vmware-solution?tabs=azure-portal["Distribuisci la soluzione Azure VMware (AVS)"]cloud privato elink:https://learn.microsoft.com/en-us/azure/azure-vmware/attach-azure-netapp-files-to-azure-vmware-solution-hosts?tabs=azure-portal["collegare gli archivi dati Azure NetApp Files"] agli host della soluzione Azure VMware.
+
Per scopi DR è possibile utilizzare un ambiente con luce pilota allestito con una configurazione minima.  In caso di incidente, le VM effettueranno il failover su questo cluster e potranno essere aggiunti nodi aggiuntivi.

. Impostare il processo di replica per creare repliche di VM utilizzando Veeam Backup and Replication.
. Creare un piano di failover ed eseguire il failover.
. Una volta completato l'evento disastroso e quando il sito primario è attivo, tornare alle VM di produzione.




=== Prerequisiti per la replica delle VM Veeam sui datastore AVS e ANF

. Assicurarsi che la VM di backup di Veeam Backup & Replication sia connessa sia ai cluster AVS SDDC di origine che a quelli di destinazione.
. Il server di backup deve essere in grado di risolvere i nomi brevi e di connettersi ai vCenter di origine e di destinazione.
. L'archivio dati di Azure NetApp Files di destinazione deve disporre di spazio libero sufficiente per archiviare i VMDK delle VM replicate.


Per ulteriori informazioni, fare riferimento alla sezione "Considerazioni e limitazioni" trattatalink:https://helpcenter.veeam.com/docs/backup/vsphere/replica_limitations.html?ver=120["Qui"] .



=== Dettagli di distribuzione

.Passaggio 1: replicare le VM
[%collapsible%open]
====
Veeam Backup & Replication sfrutta le funzionalità di snapshot di VMware vSphere. Durante la replica, Veeam Backup & Replication richiede a VMware vSphere di creare uno snapshot della VM.  Lo snapshot della VM è la copia di una VM in un dato momento che include dischi virtuali, stato del sistema, configurazione e metadati.  Veeam Backup & Replication utilizza lo snapshot come origine dei dati per la replica.

Per replicare le VM, seguire i passaggi seguenti:

. Aprire la console Veeam Backup & Replication.
. Nella vista Home.  Fare clic con il pulsante destro del mouse sul nodo dei processi e selezionare Processo di replica > Macchina virtuale.
. Specificare un nome per il lavoro e selezionare la casella di controllo avanzata appropriata. Fare clic su Avanti.
+
** Selezionare la casella di controllo Replica seeding se la connettività tra locale e Azure ha una larghezza di banda limitata.  *Selezionare la casella di controllo Rimappatura di rete (per siti AVS SDDC con reti diverse) se i segmenti su Azure VMware Solution SDDC non corrispondono a quelli delle reti dei siti locali.
** Se lo schema di indirizzamento IP nel sito di produzione locale è diverso dallo schema nel sito AVS di destinazione, selezionare la casella di controllo Replica re-IP (per siti DR con schema di indirizzamento IP diverso).
+
image:dr-veeam-anf-002.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]



. Selezionare le VM da replicare nel datastore di Azure NetApp Files collegato a un SDDC di Azure VMware Solution nel passaggio Macchine *virtuali*.  Le macchine virtuali possono essere posizionate su vSAN per riempire la capacità disponibile del datastore vSAN.  In un cluster di luci pilota, la capacità utilizzabile di un cluster a 3 nodi sarà limitata.  Il resto dei dati può essere facilmente inserito negli archivi dati di Azure NetApp Files, in modo che le macchine virtuali possano essere ripristinate e il cluster possa essere espanso per soddisfare i requisiti di CPU/memoria.  Fare clic su *Aggiungi*, quindi nella finestra *Aggiungi oggetto* selezionare le VM o i contenitori VM necessari e fare clic su *Aggiungi*. Fare clic su *Avanti*.
+
image:dr-veeam-anf-003.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

. Successivamente, selezionare la destinazione come cluster/host SDDC di Azure VMware Solution e il pool di risorse appropriato, la cartella VM e il datastore FSx ONTAP per le repliche VM.  Quindi fare clic su *Avanti*.
+
image:dr-veeam-anf-004.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

. Nel passaggio successivo, creare la mappatura tra la rete virtuale di origine e quella di destinazione in base alle esigenze.
+
image:dr-veeam-anf-005.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

. Nel passaggio *Impostazioni processo*, specificare il repository di backup in cui verranno archiviati i metadati per le repliche delle VM, i criteri di conservazione e così via.
. Aggiorna i server proxy *Origine* e *Destinazione* nel passaggio *Trasferimento dati* e lascia la selezione *Automatica* (predefinita), mantieni selezionata l'opzione *Diretta* e fai clic su *Avanti*.
. Nella fase *Elaborazione guest*, selezionare l'opzione *Abilita elaborazione basata sull'applicazione* in base alle esigenze. Fare clic su *Avanti*.
+
image:dr-veeam-anf-006.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

. Selezionare la pianificazione della replica per eseguire il processo di replica regolarmente.
+
image:dr-veeam-anf-007.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

. Nella fase *Riepilogo* della procedura guidata, rivedere i dettagli del processo di replica.  Per avviare il processo subito dopo la chiusura della procedura guidata, selezionare la casella di controllo *Esegui il processo quando faccio clic su Fine*, altrimenti lasciare la casella di controllo deselezionata.  Quindi fare clic su *Fine* per chiudere la procedura guidata.
+
image:dr-veeam-anf-008.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]



Una volta avviato il processo di replica, le VM con il suffisso specificato verranno popolate sul cluster/host AVS SDDC di destinazione.

image:dr-veeam-anf-009.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

Per ulteriori informazioni sulla replica Veeam, fare riferimentolink:https://helpcenter.veeam.com/docs/backup/vsphere/replication_process.html?ver=120["Come funziona la replicazione"]

====
.Passaggio 2: creare un piano di failover
[%collapsible%open]
====
Una volta completata la replicazione o il seeding iniziale, creare il piano di failover.  Il piano di failover consente di eseguire il failover per le VM dipendenti una alla volta o come gruppo automaticamente.  Il piano di failover è il modello per l'ordine in cui vengono elaborate le VM, inclusi i ritardi di avvio.  Il piano di failover aiuta anche a garantire che le VM dipendenti critiche siano già in esecuzione.

Per creare il piano, vai alla nuova sottosezione denominata *Repliche* e seleziona *Piano di failover*.  Scegliere le VM appropriate.  Veeam Backup & Replication cercherà i punti di ripristino più vicini a questo momento e li utilizzerà per avviare le repliche delle VM.


NOTE: Il piano di failover può essere aggiunto solo una volta completata la replica iniziale e quando le repliche delle VM sono nello stato Pronto.


NOTE: Il numero massimo di VM che possono essere avviate simultaneamente durante l'esecuzione di un piano di failover è 10


NOTE: Durante il processo di failover, le VM di origine non verranno spente

Per creare il *Piano di failover*, procedere come segue:

. Nella vista Home.  Fare clic con il pulsante destro del mouse sul nodo Repliche e selezionare Piani di failover > Piano di failover > VMware vSphere.
+
image:dr-veeam-anf-010.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

. Successivamente, fornisci un nome e una descrizione al piano.  È possibile aggiungere script pre e post-failover in base alle esigenze.  Ad esempio, eseguire uno script per arrestare le VM prima di avviare le VM replicate.
+
image:dr-veeam-anf-011.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

. Aggiungere le VM al piano e modificare l'ordine di avvio delle VM e i ritardi di avvio per soddisfare le dipendenze dell'applicazione.
+
image:dr-veeam-anf-012.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]



Per ulteriori informazioni sulla creazione di processi di replica, fare riferimentolink:https://helpcenter.veeam.com/docs/backup/vsphere/replica_job.html?ver=120["Creazione di processi di replicazione"] .

====
.Passaggio 3: eseguire il piano di failover
[%collapsible%open]
====
Durante il failover, la VM di origine nel sito di produzione viene commutata sulla sua replica nel sito di disaster recovery.  Come parte del processo di failover, Veeam Backup & Replication ripristina la replica della VM al punto di ripristino richiesto e sposta tutte le attività di I/O dalla VM di origine alla sua replica.  Le repliche possono essere utilizzate non solo in caso di disastro, ma anche per simulare esercitazioni DR.  Durante la simulazione del failover, la VM di origine rimane in esecuzione.  Una volta eseguiti tutti i test necessari, è possibile annullare il failover e tornare alle normali operazioni.


NOTE: Assicurarsi che la segmentazione della rete sia attiva per evitare conflitti IP durante il failover.

Per avviare il piano di failover, è sufficiente fare clic sulla scheda *Piani di failover* e fare clic con il pulsante destro del mouse sul piano di failover.  Selezionare **Avvia*.  Verrà eseguito il failover utilizzando i punti di ripristino più recenti delle repliche delle VM.  Per eseguire il failover su punti di ripristino specifici delle repliche delle VM, selezionare *Avvia su*.

image:dr-veeam-anf-013.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

image:dr-veeam-anf-014.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

Lo stato della replica della VM cambia da Pronto a Failover e le VM verranno avviate sul cluster/host SDDC di Azure VMware Solution (AVS) di destinazione.

image:dr-veeam-anf-015.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

Una volta completato il failover, lo stato delle VM cambierà in "Failover".

image:dr-veeam-anf-016.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]


NOTE: Veeam Backup & Replication interrompe tutte le attività di replica per la VM di origine finché la sua replica non torna allo stato Pronto.

Per informazioni dettagliate sui piani di failover, fare riferimentolink:https://helpcenter.veeam.com/docs/backup/vsphere/failover_plan.html?ver=120["Piani di failover"] .

====
.Fase 4: failback al sito di produzione
[%collapsible%open]
====
Quando il piano di failover è in esecuzione, viene considerato un passaggio intermedio e deve essere finalizzato in base ai requisiti.  Le opzioni includono quanto segue:

* *Failback in produzione*: torna alla VM originale e trasferisci tutte le modifiche apportate mentre la replica della VM era in esecuzione alla VM originale.



NOTE: Quando si esegue il failback, le modifiche vengono solo trasferite ma non pubblicate.  Selezionare *Commit failback* (una volta confermato che la VM originale funziona come previsto) oppure Annulla failback per tornare alla replica della VM se la VM originale non funziona come previsto.

* *Annulla failover*: torna alla VM originale e ignora tutte le modifiche apportate alla replica della VM mentre era in esecuzione.
* *Failover permanente*: passa in modo permanente dalla VM originale a una replica della VM e utilizza questa replica come VM originale.


In questa demo è stato scelto il failback in produzione.  Durante il passaggio Destinazione della procedura guidata è stato selezionato il failback sulla macchina virtuale originale ed è stata abilitata la casella di controllo "Accendi macchina virtuale dopo il ripristino".

image:dr-veeam-anf-017.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

image:dr-veeam-anf-018.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

image:dr-veeam-anf-019.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

image:dr-veeam-anf-020.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

Il commit di failback è uno dei modi per finalizzare l'operazione di failback.  Quando il failback viene eseguito, conferma che le modifiche inviate alla VM sottoposta a failback (la VM di produzione) funzionano come previsto.  Dopo l'operazione di commit, Veeam Backup & Replication riprende le attività di replica per la VM di produzione.

Per informazioni dettagliate sul processo di failback, fare riferimento alla documentazione Veeam perlink:https://helpcenter.veeam.com/docs/backup/vsphere/failover_failback.html?ver=120["Failover e failback per la replica"] .

image:dr-veeam-anf-021.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

Una volta completato il failback in produzione, tutte le VM vengono ripristinate nel sito di produzione originale.

image:dr-veeam-anf-022.png["Figura che mostra il dialogo di input/output o che rappresenta il contenuto scritto"]

====


== Conclusione

La funzionalità di datastore Azure NetApp Files consente a Veeam o a qualsiasi strumento di terze parti convalidato di fornire una soluzione DR a basso costo sfruttando i cluster Pilot Light anziché creare un cluster di grandi dimensioni solo per ospitare repliche di VM.  Ciò fornisce un modo efficace per gestire un piano di disaster recovery personalizzato e su misura e per riutilizzare i prodotti di backup esistenti internamente per il disaster recovery, consentendo il disaster recovery basato su cloud tramite l'uscita dai data center DR locali.  In caso di emergenza è possibile effettuare il failover cliccando su un pulsante oppure effettuare il failover automaticamente se si verifica un'emergenza.

Per saperne di più su questo processo, non esitate a seguire il video tutorial dettagliato.

video::2855e0d5-97e7-430f-944a-b061015e9278[panopto,width=Video walkthrough of the solution]